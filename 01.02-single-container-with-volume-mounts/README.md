# Purpose

This unit demonstrates the use of Podman with a single container.

Table of Contents
- [Purpose](#purpose)
  - [Getting Started](#getting-started)
  - [Running a Container](#running-a-container)
  - [Running a Container with Volume Mounts](#running-a-container-with-volume-mounts)
    - [Volume Mounts Prerequisite for MacOS](#volume-mounts-prerequisite-for-macos)
    - [Mounting a Volume](#mounting-a-volume)
    - [Volume Mount Workaround for MacOS](#volume-mount-workaround-for-macos)
      - [Instructions](#instructions)
- [References](#references)

## Getting Started

Before you can run a container, you must initialize a `podman virtual machine`.
To start the podman-managed VM:

```bash
# init the podman vm and config
$ podman machine init
Downloading VM image: fedora-coreos-35.20220213.2.0-qemu.x86_64.qcow2.xz: done
Extracting compressed file

# start the vm
$ podman machine start
Waiting for VM ...
Machine "podman-machine-default" started successfully
```

If you see the following error, it could stem from how you installed podman.
I installed it using `brew` on `MacOS`.

```bash
Error: unable to start host networking: "could not find \"gvproxy\" in one of [ ... ]
``` 

We can resolve it as follows. You need to determine the locations of the
following directories:
- Podman's bin
- Podman's libexec (where `gvproxy` lives)

Then you need to add them to the config file that was generated by the
`podman machine init` command:

```bash
# ~/.config/containers/containers.conf file
[containers]

[engine]
  active_service = "podman-machine-default"
  helper_binaries_dir=["/Users/your-username/brew/Cellar/podman/3.4.4/bin","/Users/your-username/brew/Cellar/podman/3.4.4/libexec"]
  [engine.service_destinations]
    [engine.service_destinations.podman-machine-default]
      # --- snip --- #
    [engine.service_destinations.podman-machine-default-root]
      # --- snip --- #

[machine]

[network]

[secrets]

```

> Important: it is not intended for end-users of podman to place `gvproxy`
> in their `PATH`. See this [github issue](https://github.com/containers/podman/issues/11960).

> Note: if you installed podman from source, you can build `gvproxy` from
> scratch. See the [github repository](https://github.com/containers/gvisor-tap-vsock)

At this point, you should be able to successfully start the podman VM. Once your
podman VM is running, you can run the following command for information about
the podman VM and client.

```bash
$ podman info
```

## Running a Container

Run a container from an image similarly as you would with Docker:

```bash
$ podman run -dt -p 8085:80 docker.io/library/nginx
$ curl localhost:8085
# --- snip ---#
<h1>Welcome to nginx!</h1>
# --- snip ---#
```

## Running a Container with Volume Mounts

### Volume Mounts Prerequisite for MacOS

> Important: if you are on MacOS, volume mounting over remote is not supported
> (yet). The podman client assumes the mount path(s) refers to the remote
> machine (and not your host).
> 
> See [github issue](https://github.com/containers/podman/issues/8016).
Mount a volume into a running container similarly as you would Docker. From
the root directory of this unit, run the following command:

If you are running podman on linux, skip to the next paragraph.
If you are running MacOS and you wish to utilize volume mounts, you must
copy the file contents / directories to the podman machine prior to mounting.
Otherwise, podman will complain that the source directory does not exist.

```bash
# (optional) for macos only
$ podman machine ssh sudo chown -R core /var/mnt
$ podman machine ssh sudo chown -R core /mnt
$ podman machine ssh sudo mkdir -p /mnt/html
# use the podman private key for authentication (port is random, see output
# above to find it, core@localhost:XXXXX)
$ PODMAN_MACHINE_PORT=64798
$ PODMAN_MACHINE_PRIVATE_KEY=~/.ssh/podman-machine-default
# scope down permissions on this file
$ chmod 600 $PODMAN_MACHINE_PRIVATE_KEY
# copy the html directory to the podman machine
$ scp -i $PODMAN_MACHINE_PRIVATE_KEY -P $PODMAN_MACHINE_PORT -r html/ core@localhost:/mnt/html/
```

There does exist a more
[permanent workaround](#volume-mount-workaround-for-macos) later in this
document.

### Mounting a Volume

To mount a volume on a podman container, run the following:

```bash
$ podman run -dt -p 8085:80 -v /mnt/html:/usr/share/nginx/html:Z docker.io/library/nginx
$ curl localhost:8085
# --- snip ---#
<h1>Hello World!</h1>
# --- snip ---#
```

> Note: on MacOS, the source path for the volume mount is relative to the
> file system of the podman machine.

The `:Z` mount option configures the `SELinux` label, indicating that the bind
mount content is private and unshared. Without this option on a SELinux-enabled
machine, you will receive a `permission denied` error when trying to access
the volume mount from within the container.

### Volume Mount Workaround for MacOS

There has recently been a workaround posted on this github issue
[podman/issues/#8016](https://github.com/containers/podman/issues/8016#issuecomment-1034091359).
This solution integrates [9pfs for qemu](https://wiki.qemu.org/Documentation/9psetup)

Before continuing, if you have already configured a Podman machine, remove it:

```bash
# remove your podman machines
$ podman machine stop podman-machine-default
$ podman machine rm podman-machine-default
```

> Note: these changes are not scheduled to make it into Podman v4.

For the sake of berevity, the workaround steps are listed below:

#### Instructions

If the changes make into the homebrew-core and Podman repos then this will just work and you won't need to do anything. For right now, it's still pretty easy to test:

1. Remove QEMU home brew qemu installation:

    ```
    $ brew uninstall --ignore-dependencies qemu
    ```

3. Clone fork of homebrew-core:

    ```
    $ git clone https://github.com/philnalwalker/homebrew-core && cd homebrew-core
    ```

4. Check out the ‘qemu-9pfs’ branch:

    ```
    $ git checkout qemu-9pfs
    ```

5. Change to ‘Formula’ directory:

    ```
    $ cd Formula
    ```

6. Install QEMU home brew formula from source:

    ```
    $ brew install --build-from-source ./qemu.rb
    ```

    If the above command results in a 404:

    ```
    curl: (22) The requested URL returned error: 404
    Error: qemu: Failed to download resource "qemu--homebrew-test-image"
    Download failed: https://www.ibiblio.org/pub/micro/pc-stuff/freedos/files/distributions/1.2/FD12FLOPPY.zip
    ```

    You can do one of the following:

      1. Use a homebrew solution from [this comment by @fogfish](https://github.com/containers/podman/issues/8016#issuecomment-1047905064) as recommended by
      `@philnalwalker`, the one who wrote the original workaround

          ```
          $ brew tap fogfish/qemu-9pfs
          $ brew install qemu-9pfs
          ```

      1. Update line [L45 in Formula/qemu.rb](https://github.com/philnalwalker/homebrew-core/blob/qemu-9pfs/Formula/qemu.rb#L45)
      to point to the right file and re-build from source

          ```
          https://www.ibiblio.org/pub/micro/pc-stuff/freedos/files/distributions/1.2/official/FD12FLOPPY.zip
          ```

    Continue with the remaining steps below.

7. Clone fork of Podman

    ```
    $ git clone https://github.com/philnalwalker/podman
    ```

    This assumes you have Golang setup on your Mac. Make sure to clone to your $GOPATH i.e. ~/golang/src/github.com/containers.

8. Check out the ‘9pfs’ branch:

    ```
    $ cd podman && git checkout 9pfs-v3.4
    ```

9.  Make the “podman-remote-darwin” target:

    ```
    $ make podman-remote-darwin
    ```

10. Copy Podman binary:

    ```
    # if installed manually
    $ sudo cp bin/darwin/podman /usr/local/bin/podman

    # if installed using brew
    $ sudo cp bin/darwin/podman /usr/local/bin/podman

    # verify version
    $ podman -v
    podman version 3.4.5-dev
    ```

11. Delete, recreate, and SSH into a new machine:

    ```
    $ podman machine init 
    $ podman machine start
    $ podman machine ssh
    ```

12. Verify MacOS / is mounted to /var/mnt/host:

    ```
    [core@localhost ~]$ ls -als /var/mnt/host
    ```

13. Verify you do not need to to prefix container mount operations with /var/mnt/host when using Podman Mac client:

    ```
    $ podman run -ti -v $HOME:/foobar docker.io/centos ls -als /foobar
    ```

14. (Optional) Enable rootful podman to fix issue seen with chown/permissions on volume mounts.

    ```
    $ podman system connection default podman-machine-default-root
    ```

Finally, you can verify that the `nginx` example we did earlier works with
the following command.

> Note: the below command assumes you've destroyed and rebuilt the Podman
> machine. If this was not done, then it is possible the files we copied in
> earlier are still there (and `9pfs` is not even being used).

```bash
$ podman run -dt -p 8085:80 -v $(pwd)/html:/usr/share/nginx/html docker.io/library/nginx
$ curl localhost:8085
# --- snip ---#
<h1>Hello World!</h1>
# --- snip ---#
```

# References
- [What is Podman?](https://docs.podman.io/en/latest/)
- [SELinux Labels (Podman)](https://www.redhat.com/sysadmin/user-namespaces-selinux-rootless-containers)
- [SELinux Labels (Docker)](https://docs.docker.com/storage/bind-mounts/#configure-the-selinux-label)